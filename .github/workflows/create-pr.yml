name: Create Pull Request

on:
  push:
    branches-ignore:
      - "main"
      - "master"

env:
  WORKDIR: ${{ github.workspace }}

jobs:
  create-pr:
    runs-on: ubuntu-18.04
    steps:
      - name: check out
        uses: actions/checkout@v2

      - name: current branch
        run: echo "BRANCH=`git name-rev --name-only HEAD`" >> $GITHUB_ENV

      - name: read graphql file
        id: gql
        run: |
          echo 'GQL_QUERY<<EOF' >> $GITHUB_ENV
          cat .github/create-pr.gql >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: read template of pull request
        id: template
        run: |
          echo 'TEMPLATE<<EOF' >> $GITHUB_ENV
          cat .github/pull_request_template.md >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: create pull request
        id: create_pr
        uses: actions/github-script@47f7cf65b5ced0830a325f705cad64f2f58dddf7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const script = require(`${process.env.GITHUB_WORKSPACE}/.github/create-pr.graphql.js`)
            const options = {
              baseRef: process.env.BASE,
              headRef: process.env.HEAD,
              title: process.env.TITLE,
            }

            return script({github, context, options})
        env:
          BASE: main
          HEAD: ${{ env.BRANCH }}
          TITLE: "WIP: create by actions/github-script@v3.1.0"

      - name: result
        run: echo "${{ steps.set-result.outputs.result }}"
